{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        
        <div class="col-lg-3">
            <div class="card" style="border-left: none;">
                <div class="card-body bg-light rounded-3 shadow-sm p-3" style="max-height: 80vh; overflow-y: auto;">
                    <h5 class="mb-3">
                        <i class="bi bi-clock-history me-2"></i>Historial de Análisis
                    </h5>
                    
                    <a href="{{ url_for('analysis.analysis_index') }}" class="btn btn-outline-secondary btn-sm w-100 mb-3">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Análisis
                    </a>

                    {% if historial_analisis %}
                    <div class="list-group">
                        {% for item in historial_analisis %}
                        <a href="{{ url_for('analysis.analysis_index', view_id=item.id) }}" 
                           class="list-group-item list-group-item-action 
                                  {% if analisis_obj and analisis_obj.id == item.id %}active{% endif %}">
                            
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-truncate" style="max-width: 200px;" 
                                    title="{{ item.nombre_requerimiento or 'Análisis' }}">
                                    {{ item.nombre_requerimiento or 'Análisis' }}
                                </h6>
                                <small>{{ item.timestamp.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <small class="mb-1 text-muted">
                                {{ item.casos_generados }} casos ({{ item.nivel_complejidad }})
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted small mt-4">No tienes análisis guardados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            
            <div class="card mb-4" style="border-left: none; background-color: var(--bs-secondary-dark); position: relative;">
                <div class="card-body p-4">
                    <h2 class="h4 card-title text-white mb-3">
                        <i class="bi bi-robot me-2"></i>Análisis Inteligente de Requerimientos
                    </h2>
                    <p class="card-text text-white-50">
                        El sistema analizará automáticamente la complejidad y generará la cantidad óptima de casos de prueba.
                    </p>
                    
                    {% if texto_requerimiento %}
                    <div class="position-absolute top-0 end-0 p-3" style="margin-top: 1rem; margin-right: 1rem;">
                        <button class="btn btn-light btn-sm shadow-sm" type="button" data-bs-toggle="modal" data-bs-target="#requerimientoModal">
                            <i class="bi bi-file-text-fill me-1"></i>
                            Ver Requerimiento
                        </button>
                    </div>
                    {% endif %}
                    
                    <form action="{{ url_for('analysis.analysis_index') }}" method="post" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.plantilla.label(class="form-label text-white fw-bold") }}
                                {{ form.plantilla(class="form-select form-select-lg") }}
                                {% for error in form.plantilla.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-4">
                                {{ form.archivo_requerimiento.label(class="form-label text-white fw-bold") }}
                                <div id="drop-zone" class="form-control form-control-lg d-flex align-items-center justify-content-center">
                                    <span id="drop-zone-text" class="text-muted small">
                                        <i class="bi bi-upload me-2"></i>Arrastra o selecciona archivo
                                    </span>
                                </div>
                                {{ form.archivo_requerimiento(class="d-none", id="file-input") }}
                                {% for error in form.archivo_requerimiento.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                {{ form.submit(value="Analizar IA", class="btn btn-primary btn-lg w-100") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if texto_requerimiento %}
            <div class="modal fade" id="requerimientoModal" tabindex="-1" aria-labelledby="requerimientoModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="requerimientoModalLabel">
                                <i class="bi bi-file-text me-2"></i>Requerimiento Analizado
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto;">{{ texto_requerimiento }}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if analisis_info %}
            
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body bg-light">
                    <div class="row text-center g-3">
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-speedometer2 text-primary fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Complejidad</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.nivel }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-earmark-check text-success fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Casos Generados</h6>
                                <p class="fw-bold mb-0 text-success">{{ analisis_info.casos }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-list-check text-info fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Criterios Detectados</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.criterios }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-text text-warning fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Palabras Analizadas</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.palabras }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if ai_result_data and ai_result_data is iterable and ai_result_data|length > 0 and ai_result_data[0] is mapping %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle table-sm">
                            <thead>
                                <tr>
                                    {% for header in ai_result_data[0].keys() %}
                                        <th scope="col">{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for caso in ai_result_data %}
                                    <tr>
                                        {% for key, value in caso.items() %}
                                            <td class="cell-content">
                                                {% set valor_str = value|string %}
                                                {% set max_length = 120 %}
                                                
                                                {% if valor_str|length > max_length %}
                                                    <div class="text-container">
                                                        <div class="text-preview small">{{ valor_str[:max_length] }}...</div>
                                                        <div class="text-full small" style="display: none;"><pre class="mb-0">{{ valor_str }}</pre></div>
                                                        <button class="btn btn-sm btn-outline-primary mt-1 btn-toggle-text w-100" type="button">Ver más</button>
                                                    </div>
                                                {% else %}
                                                    <span class="small">{{ valor_str }}</span>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex gap-2 mt-4 justify-content-end flex-wrap">
                        <form action="{{ url_for('analysis.clear_analysis') }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="bi bi-trash me-1"></i> Limpiar Vista
                            </button>
                        </form>
                        <a href="{{ url_for('analysis.generate_file', view_id=analisis_obj.id) }}" class="btn btn-primary">
                            <i class="bi bi-download me-1"></i> Descargar Entregable
                        </a>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">
                            <i class="bi bi-code-square me-1"></i> Ver JSON Crudo
                        </button>
                        <div class="collapse mt-3" id="jsonCollapse">
                            <div class="card card-body bg-light" style="border-left: none;">
                                <pre style="max-height: 400px; overflow-y: auto;">{{ ai_result_raw }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-danger mt-4" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Error al procesar la respuesta de la IA
                </h5>
                <p class="mb-2">La IA generó una respuesta, pero no se pudo convertir a formato JSON válido.</p>
                <hr>
                <p class="mb-2"><strong>Posibles causas:</strong></p>
                <ul>
                    <li>La IA incluyó texto explicativo antes o después del JSON.</li>
                    <li>El JSON está malformado o incompleto (esto puede pasar con análisis muy complejos).</li>
                    <li>El modelo `flash` no pudo seguir la instrucción del prompt.</li>
                </ul>
                <button class="btn btn-sm btn-outline-danger mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#errorDetails">
                    Ver respuesta completa de la IA
                </button>
                <div class="collapse mt-3" id="errorDetails">
                    <div class="card card-body bg-light">
                        <pre style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;">{{ ai_result_raw }}</pre>
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="card" style="border-left-color: var(--bs-info);">
                 <div class="card-body p-5 text-center">
                    <i class="bi bi-robot text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="h5 text-muted">
                        <i class="bi bi-lightbulb me-2"></i>Sistema de Análisis Inteligente Activado
                    </h4>
                    <p class="text-muted mb-4">
                        Inicia un nuevo análisis o selecciona uno del historial.
                    </p>
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-graph-up text-primary fs-4"></i>
                                <p class="small mb-0 mt-2">Nivel de complejidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-calculator text-success fs-4"></i>
                                <p class="small mb-0 mt-2">Cantidad óptima de casos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-bullseye text-info fs-4"></i>
                                <p class="small mb-0 mt-2">Criterios de aceptación</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-shield-check text-warning fs-4"></i>
                                <p class="small mb-0 mt-2">Cobertura estratégica</p>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<style>
    /* ... (Tus estilos existentes para tabla, drag-drop, etc.) ... */
    .table-sm td { padding: 0.5rem; font-size: 0.875rem; max-width: 200px; vertical-align: middle; }
    .cell-content { max-height: 100px; overflow: visible; }
    .text-container { max-width: 100%; }
    pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    .text-preview, .text-full { white-space: pre-wrap; word-wrap: break-word; }
    .table-hover thead th {
        background-color: var(--bs-secondary-dark);
        color: white;
        text-align: center;
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }
    #drop-zone { border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; background-color: rgba(255, 255, 255, 0.1); min-height: 58px; }
    #drop-zone.drag-over { background-color: rgba(255, 255, 255, 0.3); border-color: var(--bs-primary); transform: scale(1.02); }
    #drop-zone-text { color: rgba(255, 255, 255, 0.7) !important; pointer-events: none; }
    #drop-zone-text.file-selected { color: #fff !important; font-weight: 600; }
</style>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (Tu script existente para 'Ver más' y 'Drag-Drop') ...
    document.querySelectorAll('.btn-toggle-text').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('.text-container');
            const preview = container.querySelector('.text-preview');
            const full = container.querySelector('.text-full');
            if (full.style.display === 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
                this.textContent = 'Ver menos';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-outline-secondary');
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                this.textContent = 'Ver más';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-primary');
            }
        });
    });
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const dropZoneText = document.getElementById('drop-zone-text');
    if (dropZone && fileInput && dropZoneText) {
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay(fileInput.files[0]);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                updateFileDisplay(fileInput.files[0]);
            } else {
                dropZoneText.innerHTML = '<i class="bi bi-upload me-2"></i>Arrastra o selecciona archivo';
                dropZoneText.classList.remove('file-selected');
            }
        });
    }
    function updateFileDisplay(file) {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        dropZoneText.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i>${file.name} <small class="ms-2">(${sizeMB} MB)</small>`;
        dropZoneText.classList.add('file-selected');
    }
});
</script>
{% endblock %}