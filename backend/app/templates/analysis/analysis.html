{% extends "base.html" %}

{% block content %}

<div class="offcanvas offcanvas-start" tabindex="-1" id="historialOffcanvas" aria-labelledby="historialOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="historialOffcanvasLabel">
        <i class="bi bi-clock-history me-2"></i>Historial de Análisis
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    
    <a href="{{ url_for('analysis.analysis_index') }}" class="btn btn-outline-secondary btn-sm w-100 mb-3">
        <i class="bi bi-plus-circle me-1"></i>Nuevo Análisis
    </a>

    {% if historial_analisis %}
    <div class="list-group">
        {% for item in historial_analisis %}
        <div class="list-group-item list-group-item-action p-2 
                    {% if analisis_obj and analisis_obj.id == item.id %}active{% endif %}"
             style="border-radius: .5rem; margin-bottom: 5px; position: relative;">
            
            <div class="d-flex w-100 justify-content-between align-items-center">
                <a href="{{ url_for('analysis.analysis_index', view_id=item.id) }}" 
                   class="text-decoration-none p-2 flex-grow-1 stretched-link">
                    <strong class="mb-1 text-truncate d-block" style="max-width: 200px;" 
                        title="{{ item.nombre_requerimiento or 'Análisis' }}">
                        {{ item.nombre_requerimiento or 'Análisis' }}
                    </strong>
                    <small class="mb-1 d-block 
                                {% if analisis_obj and analisis_obj.id == item.id %}text-white-50{% else %}text-muted{% endif %}">
                        {{ item.casos_generados }} casos ({{ item.nivel_complejidad }})
                    </small>
                </a>
                             
                {% if analisis_obj and analisis_obj.id_plantilla == item.id_plantilla and analisis_obj.id != item.id %}
                <form action="{{ url_for('analysis.reuse_analysis', source_id=item.id, target_id=analisis_obj.id) }}" 
                      method="POST" class="ms-2" style="position: relative; z-index: 5;">
                    <button type="submit" class="btn btn-sm btn-outline-primary" 
                            title="Importar casos de este análisis al actual">
                        <i class="bi bi-box-arrow-down"></i>
                    </button>
                </form>
                {% endif %}
                
                <form id="form-delete-{{ item.id }}" 
                      action="{{ url_for('analysis.delete_analysis', view_id=item.id) }}" 
                      method="POST" class="ms-2" style="position: relative; z-index: 5;">
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteConfirmModal"
                            data-form-id="form-delete-{{ item.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
        <p class="text-center text-muted small mt-4">No tienes análisis guardados.</p>
    {% endif %}
  </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            
            <div class="card mb-4" style="border-left: none; background-color: var(--bs-secondary-dark);">
                <div class="card-body p-4">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-outline-light btn-sm" 
                                type="button" data-bs-toggle="offcanvas" 
                                data-bs-target="#historialOffcanvas" 
                                aria-controls="historialOffcanvas">
                            <i class="bi bi-clock-history me-1"></i> Historial
                        </button>
                        
                        {% if texto_requerimiento and analisis_obj %}
                        <button class="btn btn-light btn-sm shadow-sm" type="button" data-bs-toggle="modal" data-bs-target="#requerimientoModal">
                            <i class="bi bi-pencil-fill me-1"></i>
                            Ver/Editar Requerimiento
                        </button>
                        {% endif %}
                    </div>
                    
                    <h2 class="h4 card-title text-white mb-3">
                        <i class="bi bi-robot me-2"></i>Análisis Inteligente de Requerimientos
                    </h2>

                    <p class="card-text text-white-50">
                        El sistema analizará automáticamente la complejidad y generará la cantidad óptima de casos de prueba.
                    </p>
                    
                    <form action="{{ url_for('analysis.analysis_index') }}" method="post" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.plantilla.label(class="form-label text-white fw-bold") }}
                                {{ form.plantilla(class="form-select form-select-lg") }}
                                {% for error in form.plantilla.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-4">
                                {{ form.archivo_requerimiento.label(class="form-label text-white fw-bold") }}
                                <div id="drop-zone" class="form-control form-control-lg d-flex align-items-center justify-content-center">
                                    <span id="drop-zone-text" class="text-muted small">
                                        <i class="bi bi-upload me-2"></i>Arrastra o selecciona (.txt, .docx, .xlsx)
                                    </span>
                                </div>
                                {{ form.archivo_requerimiento(class="d-none", id="file-input") }}
                                {% for error in form.archivo_requerimiento.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                {{ form.submit(value="Analizar IA", class="btn btn-primary btn-lg w-100") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if texto_requerimiento and analisis_obj %}
<div class="modal fade" id="requerimientoModal" tabindex="-1" aria-labelledby="requerimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <form id="form-re-analyze" action="{{ url_for('analysis.re_analyze', view_id=analisis_obj.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="requerimientoModalLabel">
                        <i class="bi bi-pencil-fill me-2"></i>Requerimiento
                    </h5>
                    <div class="form-check form-switch ms-auto me-3" id="viewModeToggleContainer" style="display: none;">
                        <input class="form-check-input" type="checkbox" role="switch" id="viewModeToggle">
                        <label class="form-check-label" for="viewModeToggle">Modo Edición</label>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="excelTabsContainer" role="tablist"></ul>
                    <div class="tab-content" id="excelTabsContentContainer"></div>
                    <textarea id="main-req-textarea" name="texto_requerimiento" class="form-control" style="display: none;">{{ texto_requerimiento }}</textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="save-changes-btn" type="button" class="btn btn-success">
                        <i class="bi bi-save me-1"></i> Guardar Cambios
                    </button>
                    <button id="submit-re-analyze" type="submit" class="btn btn-primary">
                        <i class="bi bi-robot me-1"></i> Guardar y Re-Analizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

            {% if analisis_info %}
            
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body bg-light">
                    
                    <div class="row text-center g-3 row-cols-1 row-cols-md-3 row-cols-lg-5">
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-speedometer2 text-primary fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Complejidad</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.nivel }}</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-earmark-check text-success fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Casos Generados</h6>
                                <p class="fw-bold mb-0 text-success">{{ analisis_info.casos }}</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-list-check text-info fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Criterios (CA)</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.criterios }}</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-shield-check text-secondary fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Criterios (CNF)</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.criterios_no_funcionales }}</p>
                            </div>
                        </div>
                        <div class="col">
                        
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-text text-warning fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Palabras Analizadas</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.palabras }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex align-items-center mt-4 mb-3">
                        <h5 class="h6 text-muted mb-0">Estimación de Esfuerzo (IA)</h5>
                        <button type="button" class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal" data-bs-target="#estimacionInfoModal">
                            <i class="bi bi-info-circle-fill"></i> ¿Cómo se calcula?
                        </button>
                    </div>

                    <div class="row text-center g-3 row-cols-1 row-cols-md-2">
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-clock text-primary fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Horas de Diseño (Est.)</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.horas_diseño | round(1) }} hs</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-play-circle-fill text-success fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Horas de Ejecución (Est.)</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.horas_ejecucion | round(1) }} hs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if ai_result_data and ai_result_data is iterable and ai_result_data|length > 0 and ai_result_data[0] is mapping %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle table-sm">
                            <thead>
                                <tr>
                                    {% for header in ai_result_data[0].keys() %}
                                        {% if not header.startswith('__') %}
                                        <th scope="col">{{ header }}</th>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for caso in ai_result_data %}
                                    <tr>
                                        {% for key, value in caso.items() %}
                                            {% if not key.startswith('__') %}
                                            {% set valor_str = value|string %}
                                            {% set max_length = 120 %}
                                            
                                            <td class="cell-content" data-original="{{ valor_str|replace('"','&quot;') }}">
                                                <div class="cell-display">
                                                    {% if valor_str|length > max_length %}
                                                        <div class="text-container">
                                                            <div class="text-preview small">{{ valor_str[:max_length] }}...</div>
                                                            <div class="text-full small" style="display: none;"><pre class="mb-0">{{ valor_str }}</pre></div>
                                                            <button class="btn btn-sm btn-outline-primary mt-1 btn-toggle-text w-100" type="button">Ver más</button>
                                                        </div>
                                                    {% else %}
                                                        <span class="small">{{ valor_str }}</span>
                                                    {% endif %}
                                                </div>

                                                <textarea class="cell-editor form-control small d-none">{{ valor_str }}</textarea>
                                            </td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex gap-2 mt-4 justify-content-end flex-wrap">
                        
                        <form action="{{ url_for('analysis.clear_analysis') }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="bi bi-trash me-1"></i> Limpiar Vista
                            </button>
                        </form>
                        
                        <button id="resultsEditToggle" class="btn btn-warning">
                            <i class="bi bi-pencil-square me-1"></i> Activar edición
                        </button>

                        <button id="save-results-btn" class="btn btn-primary d-none">
                            <i class="bi bi-save me-1"></i> Guardar cambios
                        </button>

                        <a href="{{ url_for('analysis.generate_file', view_id=analisis_obj.id, type='excel') }}" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i> Descargar Excel
                        </a>
                        
                        <a href="{{ url_for('analysis.generate_file', view_id=analisis_obj.id, type='xml') }}" class="btn btn-info">
                            <i class="bi bi-file-earmark-code me-1"></i> Descargar XML (TestLink)
                        </a>

                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">
                            <i class="bi bi-code-square me-1"></i> Ver JSON Crudo
                        </button>
                        
                        {% if ai_result_xml_string %}
                        <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#xmlCollapse">
                            <i class="bi bi-code me-1"></i> Ver XML
                        </button>
                        {% endif %}

                        <div class="collapse mt-3" id="jsonCollapse">
                            <div class="card card-body bg-light" style="border-left: none;">
                                <pre style="max-height: 400px; overflow-y: auto;">{{ ai_result_data | tojson(indent=4) }}</pre>
                            </div>
                        </div>
                        
                        {% if ai_result_xml_string %}
                        <div class="collapse mt-3" id="xmlCollapse">
                            <div class="card card-body bg-light" style="border-left: none;">
                                <pre style="max-height: 400px; overflow-y: auto;"><code>{{ ai_result_xml_string | escape }}</code></pre>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-danger mt-4" role="alert">
                No hay datos válidos para mostrar.
            </div>
            {% endif %}

            {% else %}
            <div class="card" style="border-left-color: var(--bs-info);">
                 <div class="card-body p-5 text-center">
                    <i class="bi bi-robot text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="h5 text-muted">
                        <i class="bi bi-lightbulb me-2"></i>Sistema de Análisis Inteligente Activado
                    </h4>
                    <p class="text-muted mb-4">
                        Inicia un nuevo análisis o selecciona uno del historial.
                    </p>
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-graph-up text-primary fs-4"></i>
                                <p class="small mb-0 mt-2">Nivel de complejidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-calculator text-success fs-4"></i>
                                <p class="small mb-0 mt-2">Cantidad óptima de casos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-bullseye text-info fs-4"></i>
                                <p class="small mb-0 mt-2">Criterios de aceptación</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-shield-check text-warning fs-4"></i>
                                <p class="small mb-0 mt-2">Cobertura estratégica</p>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-left: 6px solid var(--bs-danger); border-radius: .75rem; box-shadow: 0 .5rem 1.5rem rgba(0,0,0,.15); background-color: white;">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar este análisis?</p>
                <p class="text-danger small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="estimacionInfoModal" tabindex="-1" aria-labelledby="estimacionInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="estimacionInfoModalLabel">
                    <i class="bi bi-calculator-fill me-2"></i>Justificación de la Estimación (Estándar PERT)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Las estimaciones de esfuerzo (Horas de Diseño y Ejecución) se calculan automáticamente utilizando la <strong>Técnica de Estimación de 3 Puntos (PERT)</strong>.</p>
                <p>Este es un método estándar en la gestión de proyectos, respaldado por el <strong>PMBOK© del Project Management Institute (PMI)</strong>, que proporciona una estimación ponderada más realista que un cálculo simple.</p>

                <h6 class="mt-4">Fórmula Aplicada</h6>
                <p>La fórmula central es: <code>Te = (To + 4Tm + Tp) / 6</code></p>
                
                <table class="table table-bordered table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Variable</th>
                            <th>Descripción</th>
                            <th>Valor Asignado (por Caso de Prueba)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>To</strong></td>
                            <td>Tiempo Optimista</td>
                            <td rowspan="3">
                                Los valores (To, Tm, Tp) se asignan automáticamente<br>
                                según la <strong>Complejidad (Baja, Media, Alta)</strong><br>
                                detectada por la IA.
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Tm</strong></td>
                            <td>Tiempo Más Probable</td>
                        </tr>
                        <tr>
                            <td><strong>Tp</strong></td>
                            <td>Tiempo Pesimista</td>
                        </tr>
                        <tr>
                            <td><strong>Te</strong></td>
                            <td><strong>Tiempo Estimado (Ponderado)</strong></td>
                            <td>Resultado de la fórmula PERT.</td>
                        </tr>
                    </tbody>
                </table>
                
                <hr class="my-4">
                
                <h6 class="h5">Cálculo Final</h6>
                <p>El cálculo total que ves en las tarjetas es el resultado de:</p>
                <p class="text-center fs-5 fw-bold text-primary bg-light p-3 rounded">
                    Horas Totales = (Te por Caso) × (Nro. Casos Generados)
                </p>
                <p class="text-muted small mt-3">
                    Este enfoque proporciona una estimación inicial creíble y auditable, alineada con las buenas prácticas de la industria, eliminando la subjetividad de la estimación heurística simple.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>

{% if ai_result_data and ai_result_data|length > 10 %}
    <button id="scroll-toggle-btn" class="btn btn-primary btn-lg rounded-circle shadow-lg" 
       title="Ir al final"
       style="position: fixed; bottom: 20px; right: 20px; z-index: 1050; width: 58px; height: 58px;">
        <i id="scroll-toggle-icon" class="bi bi-arrow-down"></i>
    </button>
{% endif %}

<style>
    .offcanvas {
        background-color: rgba(255, 255, 255, 0.7) !important; 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .offcanvas-header { background-color: transparent; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
    .offcanvas-body { background-color: transparent; }
    .offcanvas-body .list-group-item:not(.active) {
        background-color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .table-sm td { padding: 0.5rem; font-size: 0.875rem; max-width: 200px; vertical-align: middle; }
    .cell-content { max-height: 100px; overflow: visible; }
    .text-container { max-width: 100%; }
    
    pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    pre code {
        white-space: pre-wrap;
        word-wrap: break-word;
        color: #212529;
        background-color: transparent;
        padding: 0;
        font-family: monospace;
    }
    .text-preview, .text-full { white-space: pre-wrap; word-wrap: break-word; }
    
    .table-hover thead th {
        background-color: var(--bs-secondary-dark);
        color: white;
        text-align: center;
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }

    #drop-zone { border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; background-color: rgba(255, 255, 255, 0.1); min-height: 58px; }
    #drop-zone.drag-over { background-color: rgba(255, 255, 255, 0.3); border-color: var(--bs-primary); transform: scale(1.02); }
    
    #drop-zone-text { 
        color: rgba(255, 255, 255, 0.7) !important; 
        pointer-events: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        max-width: 95%;
        vertical-align: middle;
    }
    #drop-zone-text.file-selected { 
        color: #fff !important; 
        font-weight: 600;
    }

    #requerimientoModal .modal-content {
        background-color: rgba(255, 255, 255, 0.7) !important; 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        color: #333;
    }
    #requerimientoModal .modal-header,
    #requerimientoModal .modal-footer {
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    #requerimientoModal .modal-title {
        color: #333;
    }
    #requerimientoModal .btn-close {
        filter: none;
    }
    #excelTabsContainer {
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
        margin-bottom: 1rem;
    }
    #excelTabsContainer .nav-link {
        color: var(--bs-dark);
        opacity: 0.7;
        border: none;
    }
    #excelTabsContainer .nav-link.active {
        background-color: rgba(255, 255, 255, 0.5);
        color: var(--bs-primary-dark);
        opacity: 1;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid var(--bs-primary);
    }
    #requerimientoModal .tab-content {
        background-color: transparent;
    }
    
    .excel-grid-table td.editable-cell {
        cursor: text;
        position: relative;
    }
    .excel-grid-table td.editable-cell:hover {
        background-color: #e7f3ff;
        outline: 2px solid #007bff;
    }
    .excel-grid-table td.editing {
        padding: 0;
    }
    .cell-editor {
        width: 100%;
        min-height: 30px;
        border: 2px solid #007bff;
        padding: 4px 8px;
        font-family: inherit;
        font-size: inherit;
        resize: vertical;
    }
    .save-changes-btn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1060;
    }
    .save-changes-btn.show {
        display: block;
    }
    
    #pane-req-simple #main-req-textarea {
        height: 400px;
        font-family: monospace;
        font-size: 0.9rem;
    }
    
    .tab-pane .grid-view {
        height: 350px;
        overflow: auto;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: .5rem;
    }
    .excel-grid-table {
        border-collapse: collapse;
        width: 100%;
        font-size: 0.8rem;
    }
    .excel-grid-table th,
    .excel-grid-table td {
        border: 1px solid #dee2e6;
        padding: 4px 8px;
        min-width: 75px;
    }
    .excel-grid-table th {
        background-color: #f8f9fa;
        text-align: center;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .excel-grid-table td.cell-data {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // SOLUCIÓN: Procesar mensajes flash solo si no se procesaron antes
    const flashData = document.getElementById('flash-data');
    if (flashData && !flashData.dataset.processed) {
        const messages = JSON.parse(flashData.dataset.messages || '[]');
        if (messages.length > 0) {
            messages.forEach(function(messagePair) {
                const category = messagePair[0];
                const message = messagePair[1];
                showToast(message, category);
            });
            // Marcar como procesado para evitar duplicados
            flashData.dataset.processed = 'true';
        }
    }

    document.querySelectorAll('.btn-toggle-text').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('.text-container');
            const preview = container.querySelector('.text-preview');
            const full = container.querySelector('.text-full');
            if (full.style.display === 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
                this.textContent = 'Ver menos';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-outline-secondary');
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                this.textContent = 'Ver más';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-primary');
            }
        });
    });

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const dropZoneText = document.getElementById('drop-zone-text');
    
    if (dropZone && fileInput && dropZoneText) {
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay(fileInput.files[0]);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                updateFileDisplay(fileInput.files[0]);
            } else {
                dropZoneText.innerHTML = '<i class="bi bi-upload me-2"></i>Arrastra o selecciona (.txt, .docx, .xlsx)';
                dropZoneText.classList.remove('file-selected');
            }
        });
    }
    
    function updateFileDisplay(file) {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        let fileName = file.name;
        if (fileName.length > 35) {
            fileName = fileName.substring(0, 20) + '...' + fileName.substring(fileName.length - 12);
        }
        dropZoneText.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i>${fileName} <small class="ms-2">(${sizeMB} MB)</small>`;
        dropZoneText.classList.add('file-selected');
    }

    var deleteModal = document.getElementById('deleteConfirmModal');
    var confirmButton = document.getElementById('confirmDeleteButton');
    var formToSubmit; 
    
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var formId = button.getAttribute('data-form-id');
            formToSubmit = document.getElementById(formId);
        });
    }
    if (confirmButton) {
        confirmButton.addEventListener('click', function () {
            if (formToSubmit) {
                formToSubmit.submit();
            }
        });
    }

    const scrollBtn = document.getElementById('scroll-toggle-btn');
    const scrollIcon = document.getElementById('scroll-toggle-icon');

    if (scrollBtn && scrollIcon) {
        function updateScrollButton() {
            const isAtBottom = (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 100);
            if (isAtBottom) {
                scrollIcon.classList.remove('bi-arrow-down');
                scrollIcon.classList.add('bi-arrow-up');
                scrollBtn.setAttribute('title', 'Ir al inicio');
            } else {
                scrollIcon.classList.remove('bi-arrow-up');
                scrollIcon.classList.add('bi-arrow-down');
                scrollBtn.setAttribute('title', 'Ir al final');
            }
        }
        scrollBtn.addEventListener('click', function() {
            const isAtBottom = (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 100);
            if (isAtBottom) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        });
        window.addEventListener('scroll', updateScrollButton);
        updateScrollButton();
    }
    
    const reqModal = document.getElementById('requerimientoModal');
    
    if (reqModal) {
        const reqModalForm = document.getElementById('form-re-analyze');
        const mainTextarea = document.getElementById('main-req-textarea');
        const tabsContainer = document.getElementById('excelTabsContainer');
        const contentContainer = document.getElementById('excelTabsContentContainer');
        const toggleContainer = document.getElementById('viewModeToggleContainer');
        const toggle = document.getElementById('viewModeToggle');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const separator = "\n--- INICIO HOJA: ";
        let isEditMode = false;
        let hasUnsavedChanges = false;

        reqModal.addEventListener('show.bs.modal', function() {
            const fullText = mainTextarea.value;
            
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            isEditMode = false;
            hasUnsavedChanges = false;
            toggle.checked = false;
            saveChangesBtn.classList.remove('show');
            
            if (fullText.includes(separator)) {
                toggleContainer.style.display = 'block';
                tabsContainer.classList.add('excel-active');
                
                const parts = fullText.split(separator);
                let sheetData = [];

                if (parts[0].trim() !== '') {
                    sheetData.push({ name: 'Hoja 1 (Default)', content: parts[0] });
                }
                
                for (let i = 1; i < parts.length; i++) {
                    const contentSplit = parts[i].split(' ---\n');
                    const sheetName = contentSplit[0];
                    const sheetContent = contentSplit.slice(1).join(' ---\n');
                    sheetData.push({ name: sheetName, content: sheetContent });
                }
                
                buildExcelTabs(sheetData);

            } else {
                toggleContainer.style.display = 'none';
                tabsContainer.classList.remove('excel-active');
                
                const pane = document.createElement('div');
                pane.className = 'tab-pane fade show active';
                pane.id = 'pane-req-simple';
                pane.setAttribute('role', 'tabpanel');
                
                mainTextarea.style.display = 'block';
                pane.appendChild(mainTextarea);
                contentContainer.appendChild(pane);

                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.innerHTML = `<button class="nav-link active" id="tab-req-simple" data-bs-toggle="tab" data-bs-target="#pane-req-simple" type="button" role="tab">Requerimiento</button>`;
                tabsContainer.appendChild(tab);
            }
        });

        function buildExcelTabs(sheetData) {
            for(let i = 0; i < sheetData.length; i++) {
                const name = sheetData[i].name;
                const content = sheetData[i].content;
                const id = 'sheet-' + i;
                const isActive = (i === 0);

                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.setAttribute('role', 'presentation');
                tab.innerHTML = `
                    <button class="nav-link ${isActive ? 'active' : ''}" id="tab-${id}" data-bs-toggle="tab" data-bs-target="#pane-${id}" type="button" role="tab">${name}</button>
                `;
                tabsContainer.appendChild(tab);
                
                const pane = document.createElement('div');
                pane.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
                pane.id = `pane-${id}`;
                pane.setAttribute('role', 'tabpanel');
                pane.setAttribute('data-sheet-name', name);
                
                pane.innerHTML = buildEditableGrid(content);
                contentContainer.appendChild(pane);
            }
        }

        function buildEditableGrid(content) {
            let maxCols = 0;
            const rows = content.split('\n');
            const tableRows = [];
            
            rows.forEach(rowStr => {
                if (rowStr.trim() === '') return;
                const cells = rowStr.split(' | ');
                tableRows.push(cells);
                if (cells.length > maxCols) {
                    maxCols = cells.length;
                }
            });
            
            if (maxCols === 0) maxCols = 1;
            
            let html = '<div class="grid-view"><table class="excel-grid-table"><thead><tr>';
            for(let i = 0; i < maxCols; i++) {
                let colName = '';
                let n = i;
                do {
                    colName = String.fromCharCode(65 + (n % 26)) + colName;
                    n = Math.floor(n / 26) - 1;
                } while (n >= 0);
                html += `<th>${colName}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            tableRows.forEach((cells, rowIdx) => {
                html += '<tr>';
                for(let colIdx = 0; colIdx < maxCols; colIdx++) {
                    const cellData = cells[colIdx] || '';
                    const escapedData = cellData.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    html += `<td class="cell-data" data-row="${rowIdx}" data-col="${colIdx}">${escapedData}</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        toggle.addEventListener('change', function() {
            isEditMode = this.checked;
            toggleEditMode(isEditMode);
        });
        
        function toggleEditMode(editMode) {
            const allCells = reqModal.querySelectorAll('.excel-grid-table td.cell-data');
            
            if (editMode) {
                allCells.forEach(cell => {
                    cell.classList.add('editable-cell');
                    cell.setAttribute('contenteditable', 'false');
                });
                allCells.forEach(cell => {
                    cell.addEventListener('dblclick', handleCellDoubleClick);
                });
            } else {
                const activeEditor = reqModal.querySelector('.cell-editor');
                if (activeEditor) {
                    saveCell(activeEditor);
                }
                
                allCells.forEach(cell => {
                    cell.classList.remove('editable-cell');
                    cell.removeAttribute('contenteditable');
                    cell.removeEventListener('dblclick', handleCellDoubleClick);
                });
                hasUnsavedChanges = false;
                saveChangesBtn.classList.remove('show');
            }
        }

        function handleCellDoubleClick(e) {
            if (!isEditMode) return;
            
            const cell = e.target;
            if (cell.classList.contains('editing')) return;
            
            const activeEditor = reqModal.querySelector('.cell-editor');
            if (activeEditor) {
                saveCell(activeEditor);
            }
            
            const originalContent = cell.textContent;
            cell.classList.add('editing');
            cell.setAttribute('data-original', originalContent);
            
            const textarea = document.createElement('textarea');
            textarea.className = 'cell-editor';
            textarea.value = originalContent;
            textarea.setAttribute('data-original', originalContent);
            
            cell.textContent = '';
            cell.appendChild(textarea);
            textarea.focus();
            
            textarea.addEventListener('blur', function() {
                saveCell(textarea);
            });
            
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveCell(textarea);
                }
                if (e.key === 'Escape') {
                    cell.classList.remove('editing');
                    cell.removeAttribute('data-original');
                    cell.textContent = originalContent;
                }
            });
        }

        function saveCell(textarea) {
            const cell = textarea.parentElement;
            const newContent = textarea.value;
            const originalContent = cell.getAttribute('data-original') || '';
            
            cell.classList.remove('editing');
            cell.removeAttribute('data-original');
            cell.textContent = newContent;
            
            if (newContent !== originalContent) {
                hasUnsavedChanges = true;
                saveChangesBtn.classList.add('show');
            }
        }

        if (saveChangesBtn) {
            saveChangesBtn.addEventListener('click', function() {
                const activeEditor = reqModal.querySelector('.cell-editor');
                if (activeEditor) {
                    saveCell(activeEditor);
                }
                
                consolidateChanges();
                
                hasUnsavedChanges = false;
                saveChangesBtn.classList.remove('show');
                
                toggle.checked = false;
                toggleEditMode(false);
                
                showToast('Cambios guardados correctamente', 'success');
            });
        }

        function consolidateChanges() {
            if (!tabsContainer.classList.contains('excel-active')) return;
            
            let newFullText = '';
            const panes = contentContainer.querySelectorAll('.tab-pane');
            
            panes.forEach((pane, idx) => {
                const sheetName = pane.getAttribute('data-sheet-name');
                const table = pane.querySelector('.excel-grid-table tbody');
                if (!table) return;
                
                const rows = table.querySelectorAll('tr');
                let sheetContent = '';
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                    if (rowData.some(val => val !== '')) {
                        sheetContent += rowData.join(' | ') + '\n';
                    }
                });
                
                if (idx === 0 && sheetName === 'Hoja 1 (Default)') {
                    newFullText += sheetContent;
                } else {
                    newFullText += `${separator}${sheetName} ---\n${sheetContent}`;
                }
            });
            
            mainTextarea.value = newFullText;
        }

        if (reqModalForm) {
            reqModalForm.addEventListener('submit', function(e) {
                const activeEditor = reqModal.querySelector('.cell-editor');
                if (activeEditor) {
                    saveCell(activeEditor);
                }
                
                if (tabsContainer.classList.contains('excel-active')) {
                    consolidateChanges();
                }
                
                mainTextarea.style.display = 'block';
                mainTextarea.style.visibility = 'hidden';
                mainTextarea.style.height = '0';
            });
        }
    }
});
</script>

{% if analisis_obj %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const editBtn = document.getElementById("resultsEditToggle");
    const saveBtn = document.getElementById("save-results-btn");
    const table = document.querySelector("table.table-hover");
    let editMode = false;
    let changesPending = false;
    const saveUrl = "{{ url_for('analysis.update_results', view_id=analisis_obj.id) }}";

    editBtn?.addEventListener("click", () => {
        editMode = !editMode;

        document.querySelectorAll(".cell-editor").forEach(e => e.classList.toggle("d-none", !editMode));
        document.querySelectorAll(".cell-display").forEach(d => d.classList.toggle("d-none", editMode));

        if (editMode) {
            editBtn.innerHTML = `<i class="bi bi-x-circle me-1"></i> Cancelar edición`;
            editBtn.classList.remove("btn-warning");
            editBtn.classList.add("btn-secondary");
            saveBtn.classList.remove("d-none");
            
            document.querySelectorAll(".cell-editor").forEach(autoResizeTextarea);

        } else {
            editBtn.innerHTML = `<i class="bi bi-pencil-square me-1"></i> Activar edición`;
            editBtn.classList.add("btn-warning");
            editBtn.classList.remove("btn-secondary");
            saveBtn.classList.add("d-none");

            if (changesPending) {
                document.querySelectorAll(".cell-editor").forEach(editor => {
                    editor.value = editor.closest('.cell-content').dataset.original;
                });
                changesPending = false;
                saveBtn.classList.remove("btn-danger");
                saveBtn.classList.add("btn-primary");
                saveBtn.innerHTML = `<i class="bi bi-save me-1"></i> Guardar cambios`;
                showToast("Cambios descartados", "info");
            }
        }
    });

    saveBtn?.addEventListener("click", () => {
        if (!changesPending) {
            showToast("No hay cambios pendientes para guardar.", "info");
            return;
        }
        
        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
        const dataRows = [];
        
        table.querySelectorAll("tbody tr").forEach(row => {
            const rowData = {};
            row.querySelectorAll(".cell-editor").forEach((editor, index) => {
                const header = headers[index];
                rowData[header] = editor.value;
            });
            dataRows.push(rowData);
        });
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...`;

        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataRows)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Error en el servidor') });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message, 'success');
                changesPending = false;
                
                const casosCard = document.querySelector('.fw-bold.mb-0.text-success');
                if (casosCard) {
                    casosCard.textContent = data.casos;
                }
                
                table.querySelectorAll("tbody tr").forEach((row, rowIndex) => {
                    row.querySelectorAll(".cell-content").forEach((cell, colIndex) => {
                        const newValue = dataRows[rowIndex][headers[colIndex]];
                        cell.dataset.original = newValue.replace(/"/g, '&quot;');
                        
                        const display = cell.querySelector(".cell-display");
                        const valor_str = String(newValue);
                        const max_length = 120;
                        if (valor_str.length > max_length) {
                            if (!display.querySelector(".text-container")) {
                                display.innerHTML = `
                                    <div class="text-container">
                                        <div class="text-preview small"></div>
                                        <div class="text-full small" style="display: none;"><pre class="mb-0"></pre></div>
                                        <button class="btn btn-sm btn-outline-primary mt-1 btn-toggle-text w-100" type="button">Ver más</button>
                                    </div>
                                `;
                                display.querySelector('.btn-toggle-text').addEventListener('click', function() {
                                    const container = this.closest('.text-container');
                                    const preview = container.querySelector('.text-preview');
                                    const full = container.querySelector('.text-full');
                                    if (full.style.display === 'none') {
                                        preview.style.display = 'none';
                                        full.style.display = 'block';
                                        this.textContent = 'Ver menos';
                                        this.classList.remove('btn-outline-primary');
                                        this.classList.add('btn-outline-secondary');
                                    } else {
                                        preview.style.display = 'block';
                                        full.style.display = 'none';
                                        this.textContent = 'Ver más';
                                        this.classList.remove('btn-outline-secondary');
                                        this.classList.add('btn-outline-primary');
                                    }
                                });
                            }
                            display.querySelector(".text-preview").textContent = valor_str.substring(0, max_length) + '...';
                            display.querySelector(".text-full pre").textContent = valor_str;
                        } else {
                            display.innerHTML = `<span class="small">${valor_str}</span>`;
                        }
                    });
                });

                editBtn.click(); 
                
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Error al guardar:', error);
            showToast(`Error al guardar: ${error.message}`, 'danger');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.classList.remove("btn-danger");
            saveBtn.classList.add("btn-primary");
            saveBtn.innerHTML = `<i class="bi bi-save me-1"></i> Guardar cambios`;
        });
    });

    function autoResizeTextarea(el) {
        el.style.height = 'auto';
        el.style.height = (el.scrollHeight) + 'px';
    }
    
    document.querySelectorAll(".cell-editor").forEach(editor => {
        editor.closest('.cell-content').dataset.original = editor.value.replace(/"/g, '&quot;');

        editor.addEventListener("input", () => {
            if (!changesPending) {
                changesPending = true;
                saveBtn.classList.remove("btn-primary");
                saveBtn.classList.add("btn-danger");
                saveBtn.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> Guardar (Cambios pendientes)`;
            }
            autoResizeTextarea(editor);
        });
    });

    document.querySelectorAll("a[href*='generate_file'], form[action*='clear_analysis'] button").forEach(btn => {
        btn.addEventListener("click", (e) => {
            if (changesPending) {
                e.preventDefault();
                showToast("¡Atención! Hay cambios sin guardar. Guarda tus ediciones antes de descargar o salir.", "warning");
            }
        });
    });
});
</script>
{% endif %}

{% endblock %}