{% extends "base.html" %}

{% block content %}

<div class="offcanvas offcanvas-start" tabindex="-1" id="historialOffcanvas" aria-labelledby="historialOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="historialOffcanvasLabel">
        <i class="bi bi-clock-history me-2"></i>Historial de Análisis
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    
    <a href="{{ url_for('analysis.analysis_index') }}" class="btn btn-outline-secondary btn-sm w-100 mb-3">
        <i class="bi bi-plus-circle me-1"></i>Nuevo Análisis
    </a>

    {% if historial_analisis %}
    <div class="list-group">
        {% for item in historial_analisis %}
        <div class="list-group-item list-group-item-action p-2 
                    {% if analisis_obj and analisis_obj.id == item.id %}active{% endif %}" 
             style="border-radius: .5rem; margin-bottom: 5px; position: relative;">
            
            <div class="d-flex w-100 justify-content-between align-items-center">
                <a href="{{ url_for('analysis.analysis_index', view_id=item.id) }}" 
                   class="text-decoration-none p-2 flex-grow-1 stretched-link">
                    <strong class="mb-1 text-truncate d-block" style="max-width: 200px;" 
                        title="{{ item.nombre_requerimiento or 'Análisis' }}">
                        {{ item.nombre_requerimiento or 'Análisis' }}
                    </strong>
                    <small class="mb-1 d-block 
                                {% if analisis_obj and analisis_obj.id == item.id %}text-white-50{% else %}text-muted{% endif %}">
                        {{ item.casos_generados }} casos ({{ item.nivel_complejidad }})
                    </small>
                </a>
                
                <form id="form-delete-{{ item.id }}" 
                      action="{{ url_for('analysis.delete_analysis', view_id=item.id) }}" 
                      method="POST" class="ms-2" style="position: relative; z-index: 5;">
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteConfirmModal"
                            data-form-id="form-delete-{{ item.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-muted small mt-4">No tienes análisis guardados.</p>
    {% endif %}
  </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            
            <div class="card mb-4" style="border-left: none; background-color: var(--bs-secondary-dark);">
                <div class="card-body p-4">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-outline-light btn-sm" 
                                type="button" data-bs-toggle="offcanvas" 
                                data-bs-target="#historialOffcanvas" 
                                aria-controls="historialOffcanvas">
                            <i class="bi bi-clock-history me-1"></i> Historial
                        </button>
                        
                        {% if texto_requerimiento %}
                        <button class="btn btn-light btn-sm shadow-sm" type="button" data-bs-toggle="modal" data-bs-target="#requerimientoModal">
                            <i class="bi bi-file-text-fill me-1"></i>
                            Ver Requerimiento
                        </button>
                        {% endif %}
                    </div>
                    
                    <h2 class="h4 card-title text-white mb-3">
                        <i class="bi bi-robot me-2"></i>Análisis Inteligente de Requerimientos
                    </h2>

                    <p class="card-text text-white-50">
                        El sistema analizará automáticamente la complejidad y generará la cantidad óptima de casos de prueba.
                    </p>
                    
                    <form action="{{ url_for('analysis.analysis_index') }}" method="post" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.plantilla.label(class="form-label text-white fw-bold") }}
                                {{ form.plantilla(class="form-select form-select-lg") }}
                                {% for error in form.plantilla.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-4">
                                {{ form.archivo_requerimiento.label(class="form-label text-white fw-bold") }}
                                <div id="drop-zone" class="form-control form-control-lg d-flex align-items-center justify-content-center">
                                    <span id="drop-zone-text" class="text-muted small">
                                        <i class="bi bi-upload me-2"></i>Arrastra o selecciona archivo
                                    </span>
                                </div>
                                {{ form.archivo_requerimiento(class="d-none", id="file-input") }}
                                {% for error in form.archivo_requerimiento.errors %}
                                    <span class="text-warning small d-block mt-1">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                {{ form.submit(value="Analizar IA", class="btn btn-primary btn-lg w-100") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if texto_requerimiento and analisis_obj %}
            <div class="modal fade" id="requerimientoModal" tabindex="-1" aria-labelledby="requerimientoModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <form action="{{ url_for('analysis.re_analyze', view_id=analisis_obj.id) }}" method="POST">
                            <div class="modal-header">
                                <h5 class="modal-title" id="requerimientoModalLabel">
                                    <i class="bi bi-pencil-fill me-2"></i>Editar y Re-Analizar Requerimiento
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <textarea name="texto_requerimiento" class="form-control" style="height: 400px; font-family: monospace; font-size: 0.9rem;">{{ texto_requerimiento }}</textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-robot me-1"></i> Guardar y Re-Analizar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if analisis_info %}
            
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body bg-light">
                    <div class="row text-center g-3">
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-speedometer2 text-primary fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Complejidad</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.nivel }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-earmark-check text-success fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Casos Generados</h6>
                                <p class="fw-bold mb-0 text-success">{{ analisis_info.casos }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-list-check text-info fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Criterios Detectados</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.criterios }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <i class="bi bi-file-text text-warning fs-2 mb-2"></i>
                                <h6 class="text-muted small mb-1">Palabras Analizadas</h6>
                                <p class="fw-bold mb-0">{{ analisis_info.palabras }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if ai_result_data and ai_result_data is iterable and ai_result_data|length > 0 and ai_result_data[0] is mapping %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle table-sm">
                            <thead>
                                <tr>
                                    {% for header in ai_result_data[0].keys() %}
                                        <th scope="col">{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for caso in ai_result_data %}
                                    <tr>
                                        {% for key, value in caso.items() %}
                                            <td class="cell-content">
                                                {% set valor_str = value|string %}
                                                {% set max_length = 120 %}
                                                
                                                {% if valor_str|length > max_length %}
                                                    <div class="text-container">
                                                        <div class="text-preview small">{{ valor_str[:max_length] }}...</div>
                                                        <div class="text-full small" style="display: none;"><pre class="mb-0">{{ valor_str }}</pre></div>
                                                        <button class="btn btn-sm btn-outline-primary mt-1 btn-toggle-text w-100" type="button">Ver más</button>
                                                    </div>
                                                {% else %}
                                                    <span class="small">{{ valor_str }}</span>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex gap-2 mt-4 justify-content-end flex-wrap">
                        <form action="{{ url_for('analysis.clear_analysis') }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="bi bi-trash me-1"></i> Limpiar Vista
                            </button>
                        </form>
                        <a href="{{ url_for('analysis.generate_file', view_id=analisis_obj.id) }}" class="btn btn-primary">
                            <i class="bi bi-download me-1"></i> Descargar Entregable
                        </a>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">
                            <i class="bi bi-code-square me-1"></i> Ver JSON Crudo
                        </button>
                        <div class="collapse mt-3" id="jsonCollapse">
                            <div class="card card-body bg-light" style="border-left: none;">
                                <pre style="max-height: 400px; overflow-y: auto;">{{ ai_result_raw }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-danger mt-4" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Error al procesar la respuesta de la IA
                </h5>
                <p class="mb-2">La IA generó una respuesta, pero no se pudo convertir a formato JSON válido.</p>
                <hr>
                <p class="mb-2"><strong>Posibles causas:</strong></p>
                <ul>
                    <li>La IA incluyó texto explicativo antes o después del JSON.</li>
                    <li>El JSON está malformado o incompleto.</li>
                </ul>
                <button class="btn btn-sm btn-outline-danger mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#errorDetails">
                    Ver respuesta completa de la IA
                </button>
                <div class="collapse mt-3" id="errorDetails">
                    <div class="card card-body bg-light">
                        <pre style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;">{{ ai_result_raw }}</pre>
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="card" style="border-left-color: var(--bs-info);">
                 <div class="card-body p-5 text-center">
                    <i class="bi bi-robot text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="h5 text-muted">
                        <i class="bi bi-lightbulb me-2"></i>Sistema de Análisis Inteligente Activado
                    </h4>
                    <p class="text-muted mb-4">
                        Inicia un nuevo análisis o selecciona uno del historial.
                    </p>
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-graph-up text-primary fs-4"></i>
                                <p class="small mb-0 mt-2">Nivel de complejidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-calculator text-success fs-4"></i>
                                <p class="small mb-0 mt-2">Cantidad óptima de casos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-bullseye text-info fs-4"></i>
                                <p class="small mb-0 mt-2">Criterios de aceptación</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-shield-check text-warning fs-4"></i>
                                <p class="small mb-0 mt-2">Cobertura estratégica</p>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-left: 6px solid var(--bs-danger); border-radius: .75rem; box-shadow: 0 .5rem 1.5rem rgba(0,0,0,.15); background-color: white;">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar este análisis?</p>
                <p class="text-danger small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% if ai_result_data and ai_result_data|length > 10 %}
    <button id="scroll-toggle-btn" class="btn btn-primary btn-lg rounded-circle shadow-lg" 
       title="Ir al final"
       style="position: fixed; bottom: 20px; right: 20px; z-index: 1050; width: 58px; height: 58px;">
        <i id="scroll-toggle-icon" class="bi bi-arrow-down"></i>
    </button>
{% endif %}


<style>
    /* Estilo "Glassmorphism" para el Sidebar (Sin cambios) */
    .offcanvas {
        background-color: rgba(255, 255, 255, 0.7) !important; 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .offcanvas-header {
        background-color: transparent; 
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    .offcanvas-body {
        background-color: transparent; 
    }
    .offcanvas-body .list-group-item:not(.active) {
        background-color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Estilos de tabla, drag-drop (Sin cambios) */
    .table-sm td { padding: 0.5rem; font-size: 0.875rem; max-width: 200px; vertical-align: middle; }
    .cell-content { max-height: 100px; overflow: visible; }
    .text-container { max-width: 100%; }
    pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    .text-preview, .text-full { white-space: pre-wrap; word-wrap: break-word; }
    .table-hover thead th {
        background-color: var(--bs-secondary-dark);
        color: white;
        text-align: center;
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }
    #drop-zone { border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; background-color: rgba(255, 255, 255, 0.1); min-height: 58px; }
    #drop-zone.drag-over { background-color: rgba(255, 255, 255, 0.3); border-color: var(--bs-primary); transform: scale(1.02); }
    #drop-zone-text { color: rgba(255, 255, 255, 0.7) !important; pointer-events: none; }
    #drop-zone-text.file-selected { color: #fff !important; font-weight: 600; }
</style>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ... (Tu script existente para 'Ver más', 'Drag-Drop' y 'Modal de Borrado') ...
    document.querySelectorAll('.btn-toggle-text').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('.text-container');
            const preview = container.querySelector('.text-preview');
            const full = container.querySelector('.text-full');
            if (full.style.display === 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
                this.textContent = 'Ver menos';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-outline-secondary');
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                this.textContent = 'Ver más';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-primary');
            }
        });
    });
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const dropZoneText = document.getElementById('drop-zone-text');
    if (dropZone && fileInput && dropZoneText) {
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay(fileInput.files[0]);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                updateFileDisplay(fileInput.files[0]);
            } else {
                dropZoneText.innerHTML = '<i class="bi bi-upload me-2"></i>Arrastra o selecciona archivo';
                dropZoneText.classList.remove('file-selected');
            }
        });
    }
    function updateFileDisplay(file) {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        dropZoneText.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i>${file.name} <small class="ms-2">(${sizeMB} MB)</small>`;
        dropZoneText.classList.add('file-selected');
    }

    var deleteModal = document.getElementById('deleteConfirmModal');
    var confirmButton = document.getElementById('confirmDeleteButton');
    var formToSubmit; 
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var formId = button.getAttribute('data-form-id');
            formToSubmit = document.getElementById(formId);
        });
        confirmButton.addEventListener('click', function () {
            if (formToSubmit) {
                formToSubmit.submit();
            }
        });
    }

    // Botón Scroll Toggle (Sin cambios)
    const scrollBtn = document.getElementById('scroll-toggle-btn');
    const scrollIcon = document.getElementById('scroll-toggle-icon');

    if (scrollBtn && scrollIcon) {
        
        function updateScrollButton() {
            const isAtBottom = (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 100);

            if (isAtBottom) {
                scrollIcon.classList.remove('bi-arrow-down');
                scrollIcon.classList.add('bi-arrow-up');
                scrollBtn.setAttribute('title', 'Ir al inicio');
            } else {
                scrollIcon.classList.remove('bi-arrow-up');
                scrollIcon.classList.add('bi-arrow-down');
                scrollBtn.setAttribute('title', 'Ir al final');
            }
        }
        scrollBtn.addEventListener('click', function() {
            const isAtBottom = (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 100);
            
            if (isAtBottom) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        });
        window.addEventListener('scroll', updateScrollButton);
        updateScrollButton();
    }
});
</script>
{% endblock %}